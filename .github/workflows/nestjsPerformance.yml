name: NestJS Performance Test

on: [push]

jobs:
    performance:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22.13"

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Install dependencies
              run: pnpm install

            - name: Build NestJS application
              run: pnpm run build

            - name: Start NestJS application
              run: pnpm run start:prod &
              env:
                  PORT: 3000
              shell: bash

            - name: Wait for app to start
              run: sleep 10
              shell: bash

            - name: Install Autocannon
              run: npm install -g autocannon

            - name: Run Performance Test (Display Table)
              run: |
                  autocannon -c 10 -d 10 -m POST \
                    -H 'Content-Type: application/json' \
                    -b '{"text": "Esta é uma mensagem de teste para análise de sentimento.", "userId": "user_test_123"}' \
                    http://localhost:3000/analyze
              shell: bash

            - name: Run Performance Test (JSON for Validation)
              id: performance_validation
              run: |
                  PERF_JSON_REPORT=$(autocannon --json -c 10 -d 10 -m POST \
                    -H 'Content-Type: application/json' \
                    -b '{"text": "Esta é uma mensagem de teste para análise de sentimento.", "userId": "user_test_123"}' \
                    http://localhost:3000/analyze)
                  echo "$PERF_JSON_REPORT" > performance_report.json

                  # Extract average latency using jq
                  AVG_LATENCY=$(echo "$PERF_JSON_REPORT" | jq -r '.latency.average')
                  echo "Average Latency: $AVG_LATENCY ms"

                  # Define the threshold (200ms)
                  THRESHOLD=200

                  # Compare and set job status
                  # Using 'bc' for floating point comparison
                  if (( $(echo "$AVG_LATENCY > $THRESHOLD" | bc -l) )); then
                    echo "Performance test failed: Average latency ($AVG_LATENCY ms) is above threshold ($THRESHOLD ms)."
                    exit 1
                  else
                    echo "Performance test passed: Average Latency ($AVG_LATENCY ms) is within threshold ($THRESHOLD ms)."
                  fi
              shell: bash

            - name: Upload performance report
              uses: actions/upload-artifact@v4
              with:
                  name: performance-report
                  path: performance_report.json
